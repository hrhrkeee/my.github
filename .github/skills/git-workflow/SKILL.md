---
name: git-workflow
description: >
  プロジェクトのGitワークフローに関する詳細な実行要件。
  ブランチ作成、コミットメッセージフォーマット、コミット粒度の基準を定義する。
---

# Git Workflow

プロジェクトのGitワークフローに関する詳細な実行要件。

## ブランチ戦略

プロジェクトを編集する際は、ローカルリポジトリで新規ブランチを作成する:

```bash
git checkout -b feature/your-feature-name
```

- ブランチ名は英語、小文字、ハイフン区切り
- プレフィックス: `feature/`, `fix/`, `refactor/`, `docs/`
- 例: `feature/add-clip-search`, `fix/video-processor`, `refactor/clean-imports`

## コミットタイミング

- 変更は適切なタイミングでコミットする（TODOの途中も可）
- 論理的にまとまった単位でコミットする
- リモートへのpushは行わない（マージは手動で実施する）

## コミットメッセージフォーマット

```
タイトル（1行で変更の概要を簡潔に）

詳細な説明（1行以上）
- 変更内容の詳細
- 関連する複数の変更を一緒に行った場合はその理由
- なぜこの変更が必要か
```

### タイトル行

- 50文字以内を目標
- 動詞で始める（日本語の場合は体言止めも可）
- 末尾にピリオド不要

### 詳細説明

- タイトルだけでは伝わらない背景・理由を記載
- 箇条書きを推奨（`-` を使用）
- どのファイルに何をしたかより、「なぜ」を重視

### 例

```
データローダーとバッチ処理の最適化

- DataLoader のワーカープロセス数を CPU コア数に最適化
- バッチサイズ計算ロジックを GPU メモリに合わせて調整
- これに伴い main.py の学習パイプラインも更新
```

```
transformers を 4.x にダウングレード

- transformers 5.x と CLYPModel の互換性問題を解決
- all_tied_weights_keys 属性エラーを回避
- リファレンス実装に合わせて 4.57.6 に固定
```

## コミット粒度の基準

### 適切な粒度

論理的に関連する変更をまとめてコミットする:

**✅ 良い例**:
- 「モデルのこの部分を修正し、それに合わせて関連する前処理部分も修正した」→ 1コミット
- 「新機能の実装に必要な3つのファイルを作成」→ 1コミット
- 「バグ修正とそれに伴うテストの追加」→ 1コミット

**❌ 避ける例**:
- 1行変更するたびにコミット（細かすぎ）
- 150行以上の無関係な変更を1つにまとめる（粗すぎ）
- 異なる目的の変更を1つのコミットにまとめる（例: バグ修正と新機能を同時）

### コミット分割の判断基準

1つのコミットは以下を満たすべき:

1. **単一の目的** - 「何を」「なぜ」が1文で説明できる
2. **原子性** - コミット適用後もコードが一貫して動作する
3. **レビュー可能** - 変更内容を追跡・理解できる程度の量

### ワークフロー例

```bash
# 1. 新機能用のブランチ作成
git checkout -b feature/clip-video-search

# 2. 実装 → 適切なタイミングでコミット
git add clip-search-engine/video_processor.py
git commit -m "PyAV による動画フレーム抽出機能を実装

- OpenCV → PyAV でシークベースの高速化
- extract_frames_by_count() 追加
- get_video_info() の実装"

# 3. 関連する変更を追加 → コミット
git add clip-search-engine/search_engine.py
git commit -m "SearchEngine に動画登録機能を統合

- register_video() で video_processor を使用
- tqdm 進捗表示を追加
- cache_dir の伝播処理"

# 4. マージは手動で実施（pushしない）
```

## コメント

- コミット後も `git log` で履歴を確認し、粒度が適切か振り返る
- 疑問があれば、より細かく分割する方を選ぶ
- CI/CDがある場合は、各コミットでテストがパスすることを確認する
